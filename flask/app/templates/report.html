{% extends "base.html" %}
{% block content %}
<div class="span11">
	<p>You have successfully saved your {{ report_type_name }} data as {{ data.email.data }} for {{ data.local.data }}.</p>
	<table class="table table-striped table-bordered">
		<thead>
			<tr>
				<th>Date</th>
				<th>Obligated</th>
				<th>Full Dues Payers</th>
				<th>Partial Dues Payers</th>
				<th>Member Cards</th>
				<th>Political Cards</th>
				<th>Political Payers</th>
				<th>Addresses</th>
				<th>Work Emails</th>
				<th>Home Emails</th>
				<th>Text Authorizations</th>
				<th>Home Phones</th>
				<th>Cell Phones</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>{{ data.as_of_date.data }}</td>
				<td>{{ data.obligation_count.data }}</td>
				<td>{{ data.full_dues_count.data }}</td>
				<td>{{ data.partial_dues_count.data }}</td>
				<td>{{ data.member_card_count.data }}</td>
				<td>{{ data.political_card_count.data }}</td>
				<td>{{ data.political_contributor_count.data }}</td>
				<td>{{ data.mailing_count.data }}</td>
				<td>{{ data.work_email_count.data }}</td>
				<td>{{ data.home_email_count.data }}</td>
				<td>{{ data.sms_count.data }}</td>
				<td>{{ data.home_phone_count.data }}</td>
				<td>{{ data.cell_phone_count.data }}</td>
			</tr>
		</tbody>
	</table>
</div>
<button onClick="generateCSV()">Export as CSV</button>

<h1 id="report_title">{{ report_name }}</h1>
<h2>Universe</h2>
<div id="universe1_holder">
    <!--canvas id="universe1_chart" width="300" height="300" /-->
</div>
<div id="dues_holder">
    <canvas id="dues_chart" width="300" height="300" />
</div>
<div></div>
<h2>Political Engagement</h2>
<div id="political_holder">
    <canvas id="political_chart" width="300" height="300" />
</div>
<h2>Contact Avenues</h2>
<div id="contact_holder">
    <!-- canvas id="contact_chart" width="300" height="300" /-->
</div>

<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="static/js/metrics.js"></script>
<script>
function generateCSV() {
	csvData = [["Date", "Obligation","Full Dues Payers","Partial Dues Payers","Member Cards","Political Cards", "Political Payers", "Addresses", "Work Emails", "Home Emails", "Text Authorizations", "Home Phones", "Cell Phones"],["{{ data.as_of_date.data }}", "{{ data.obligation_count.data }}", "{{ data.full_dues_count.data }}", "{{ data.partial_dues_count.data }}", "{{ data.member_card_count.data }}", "{{ data.political_card_count.data }}", "{{ data.political_contributor_count.data }}", "{{ data.mailing_count.data }}", "{{ data.work_email_count.data }}", "{{ data.work_email_count.data }}", "{{ data.home_email_count.data }}", "{{ data.sms_count.data }}", "{{ data.home_phone_count.data }}", "{{ data.cell_phone_count.data }}"]];
	exportToCsv('report.csv', csvData);
}
function exportToCsv(filename, rows) {
  var processRow = function (row) {
      var finalVal = '';
      for (var j = 0; j < row.length; j++) {
          var innerValue = row[j] === null ? '' : row[j].toString();
          if (row[j] instanceof Date) {
              innerValue = row[j].toLocaleString();
          };
          var result = innerValue.replace(/"/g, '""');
          if (result.search(/("|,|\n)/g) >= 0)
              result = '"' + result + '"';
          if (j > 0)
              finalVal += ',';
          finalVal += result;
      }
      return finalVal + '\n';
  };

  var csvFile = '';
  for (var i = 0; i < rows.length; i++) {
      csvFile += processRow(rows[i]);
  }

  var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
  if (navigator.msSaveBlob) { // IE 10+
      navigator.msSaveBlob(blob, filename);
  } else {
      var link = document.createElement("a");
      if (link.download !== undefined) { // feature detection
          // Browsers that support HTML5 download attribute
          var url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", filename);
          link.style = "visibility:hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      }
  }
}
</script>

<!-- Report display options -->
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script src="static/js/Chart.js"></script>
<script src="static/js/Chart.Doughnut.js"></script>
<script src="static/js/chartDataSetGeneration.js"></script>
<script>
    $(document).ready(function () {
    	var myMetrics = seiuMetrics;
			seiuMetrics.setValues(
				'{{ data.email.data }}',
				'{{ data.local.data }}',
				'{{ data.report_name.data }}',
				'{{ report_type_name }}',
				'{{ data.as_of_date.data }}',
				{{ data.obligation_count.data }},
				{{ data.full_dues_count.data }},
				{{ data.partial_dues_count.data }},
				{{ data.member_card_count.data }},
				{{ data.political_card_count.data }},
				{{ data.political_contributor_count.data }},
				{{ data.mailing_count.data if data.mailing_count.data else 0 }}, // optional from here down
				{{ data.home_email_count.data if data.home_email_count.data else 0 }},
				{{ data.work_email_count.data if data.work_email_count.data else 0 }},
				{{ data.sms_count.data if data.sms_count.data else 0 }},
				{{ data.home_phone_count.data if data.home_phone_count.data else 0 }},
				{{ data.cell_phone_count.data if data.cell_phone_count.data else 0 }}
			);
			seiuMetrics.calculateMetrics();
			var reportMetrics = seiuMetrics.getMetricsOutput();
      {% raw %}
      var chartOptions = { legendTemplate: "<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<segments.length; i++){%><li><span style=\"background-color:<%=segments[i].fillColor%>\"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>" }
     	{% endraw %}
     	console.log(reportMetrics);
      var universeData = generateUniverseChartDataSet(reportMetrics);
      console.log(universeData);
      //var ctx = $("#universe1_chart").get(0).getContext("2d");
      //window.universeChart = new Chart(ctx).Bar(universeData, chartOptions);
      //$("#universe_chart").after(window.universeChart.generateLegend());

        var duesData = generateDuesChartDataSet(reportMetrics);

        var ctx = $("#dues_chart").get(0).getContext("2d");
        window.duesChart = new Chart(ctx).Pie(duesData, chartOptions);
        $("#dues_chart").after(window.duesChart.generateLegend());

        var political_contributorData = generatePoliticalChartDataSet(reportMetrics);

        var ctx = $("#political_chart").get(0).getContext("2d");
        window.politicalChart = new Chart(ctx).Pie(political_contributorData, chartOptions);
        $("#political_chart").after(window.politicalChart.generateLegend());

        var contactData = generateContactChartDataSet(reportMetrics);

        //var ctx = $("#contact_chart").get(0).getContext("2d");
        //window.contactChart = new Chart(ctx).Bar(contactData, chartOptions);
        //$("#contact_chart").after(window.contactChart.generateLegend());
    });



    </script>

</script>
<!-- End Report display options -->
{% endblock %}